<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Iron Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #000; color: #fff; letter-spacing: -0.02em; }
    .bg-card { background-color: #0c0c0c; }
    .bg-set { background-color: #161616; }
    .text-neon { color: #10b981; }
    .bg-neon { background-color: #10b981; }
    input[type="number"]::-webkit-inner-spin-button { display: none; }
    
    input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
      cursor: pointer;
    }

    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .animate-slide-up { animation: slideUp 0.4s ease-out forwards; }
    
    #photo-fab {
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.custom-scrollbar::-webkit-scrollbar {
  width: 4px;
}
.custom-scrollbar::-webkit-scrollbar-track {
  background: transparent;
}
.custom-scrollbar::-webkit-scrollbar-thumb {
  background: #10b981;
  border-radius: 10px;
}
  </style>
</head>
<body class="max-w-md mx-auto min-h-screen pb-24 px-6">

  <div id="weight-modal" 
       onclick="closeModalOutside(event)"
       class="fixed inset-0 bg-black/85 z-[100] hidden items-center justify-center p-6 transition-all">
    <div id="modal-content" class="bg-card w-full max-w-sm rounded-[2.5rem] p-8 border border-white/10 shadow-2xl relative animate-slide-up">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-black uppercase tracking-tighter text-neon">Weight Progress</h2>
        <button onclick="toggleModal()" class="text-gray-500 hover:text-white transition-colors">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <div class="flex gap-2 mb-6 items-end">
        <div class="flex-1">
          <label class="text-[8px] uppercase font-bold text-gray-600 block mb-1 ml-1">Start</label>
          <input type="date" id="filter-start" class="w-full bg-black border border-white/5 rounded-lg p-2 text-[10px] text-white focus:outline-none focus:border-neon">
        </div>
        <div class="flex-1">
          <label class="text-[8px] uppercase font-bold text-gray-600 block mb-1 ml-1">End</label>
          <input type="date" id="filter-end" class="w-full bg-black border border-white/5 rounded-lg p-2 text-[10px] text-white focus:outline-none focus:border-neon">
        </div>
        <button onclick="refreshChartWithFilter()" class="bg-neon text-black p-2.5 rounded-lg hover:scale-95 transition-transform">
          <i data-lucide="search" class="w-4 h-4"></i>
        </button>
      </div>

      <div class="h-60 w-full mb-4">
        <canvas id="weightChart"></canvas>
      </div>
      <p class="text-[9px] text-gray-700 text-center uppercase font-bold tracking-widest italic">Syncing with Cloud Data</p>
    </div>
  </div>
  
<div id="photo-modal" 
     onclick="closePhotoModalOutside(event)"
     class="fixed inset-0 bg-black/85 z-[100] hidden items-center justify-center p-6 transition-all">
  
  <div id="photo-content" class="bg-card w-full max-w-sm rounded-[2.5rem] p-8 border border-white/10 shadow-2xl relative animate-slide-up flex flex-col max-h-[80vh]">
    
    <div class="flex justify-between items-center mb-6 flex-shrink-0">
      <h2 class="text-xl font-black uppercase tracking-tighter text-neon">TRANSFORMATION LOG</h2>
      <button onclick="togglePhotoModal()" class="text-gray-500 hover:text-white transition-colors">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>

    <div id="gallery-container" class="grid grid-cols-2 gap-3 overflow-y-auto pr-2 custom-scrollbar">
      </div>

    <p class="text-[9px] text-gray-700 text-center uppercase font-bold tracking-widest mt-6 italic flex-shrink-0 italic">Visualizing Progress</p>
  </div>
</div>

<header class="py-10 flex justify-between items-center">
  <div>
    <h1 class="text-2xl font-black uppercase tracking-tight">IRON<span class="text-neon">TRACKER</span></h1>
    <p class="text-[10px] text-gray-600 font-bold uppercase tracking-widest mt-1">Consistency is King</p>
  </div>
  <div class="flex items-center gap-4">
    <button onclick="togglePhotoModal()" class="p-2 bg-white/5 rounded-full border border-white/10">
      <i data-lucide="image" class="w-5 h-5 text-neon"></i>
    </button>
    <div class="text-right">
      <div id="streak-val" class="text-2xl font-black text-neon">ðŸ”¥ 0</div>
      <p class="text-[9px] text-gray-600 uppercase font-bold">Streak</p>
    </div>
  </div>
</header>

  <section class="bg-card border border-white/5 p-5 rounded-2xl flex justify-between items-center mb-6">
    <div>
      <h2 class="text-[10px] font-bold uppercase text-gray-500 mb-1">Body Weight</h2>
      <div class="flex items-baseline gap-1">
        <input type="number" id="body-weight-input" onchange="updateBodyWeight(this.value)" 
               class="bg-transparent text-2xl font-black text-white w-20 focus:outline-none" step="0.1">
        <span class="text-xs text-neon font-bold uppercase">kg</span>
      </div>
    </div>
    <button onclick="toggleModal()" class="p-3 bg-white/5 rounded-xl hover:bg-neon/10 transition-all group">
      <i data-lucide="trending-up" class="text-gray-600 group-hover:text-neon w-5 h-5 transition-colors"></i>
    </button>
  </section>

  <section id="meal-section" class="bg-card border border-white/5 p-6 rounded-3xl mb-10 shadow-lg">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-[10px] font-bold uppercase text-neon tracking-widest">Fuel Schedule</h2>
      <span id="meal-time" class="text-[10px] font-bold text-gray-500 bg-black px-3 py-1 rounded-full italic">--:--</span>
    </div>
    <h3 id="meal-name" class="text-xl font-bold uppercase mb-1">...</h3>
    <p id="meal-items" class="text-xs text-gray-500 italic mb-6">...</p>
    <button id="btn-meal" onclick="finishMeal(this)" class="w-full bg-neon text-black font-bold py-4 rounded-xl text-xs uppercase tracking-widest active:scale-95 transition-all">
      Mark Consumed
    </button>
  </section>

  <section>
    <div class="flex justify-between items-center mb-6 px-1">
      <h2 class="text-[11px] font-bold uppercase text-gray-600 tracking-widest">Routine</h2>
      <select id="program-select" onchange="loadWorkout()" class="bg-transparent text-xs font-black text-neon focus:outline-none uppercase cursor-pointer">
        <option value="">Syncing...</option>
      </select>
    </div>
    <div id="workout-container" class="space-y-6"></div>
  </section>

<div id="timer-box" class="fixed bottom-8 left-[calc(50%+45px)] hidden bg-white text-black p-2 pl-4 rounded-full flex items-center gap-3 z-50 shadow-2xl border-2 border-black animate-slide-up">
  <span id="timer-display" class="font-black text-lg min-w-[45px] text-center">3:00</span>
  <button onclick="stopTimer()" class="bg-black text-white text-[8px] font-bold px-4 py-2 rounded-full uppercase active:scale-95 transition-all">Skip</button>
</div>

<div id="photo-fab" class="fixed bottom-8 left-1/2 -translate-x-1/2 z-[60] transition-all duration-300 transform">
  <label class="flex items-center justify-center w-16 h-16 bg-neon text-black rounded-full shadow-[0_10_40px_rgba(16,185,129,0.4)] cursor-pointer hover:scale-110 active:scale-90 transition-all border-4 border-black">
    <i data-lucide="camera" class="w-7 h-7"></i>
    <input type="file" accept="image/*" class="hidden" onchange="uploadProgressPhoto(this)">
  </label>
</div>

  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycby4qRhpbyqZOzs6-xES-HURLpmoQy6Od4ggXsKzK-Vc9g8PXAQOSh2tNWNa48o8722RpA/exec'; 
    let weightChartInstance = null;
    let timerInterval;

    async function callGAS(func, data = {}) {
      const response = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ func, data }) });
      return response.json();
    }

    // --- UI HELPERS ---
    function showToast(message) {
      const oldContainer = document.querySelector('.toast-container');
      if (oldContainer) oldContainer.remove();

      const container = document.createElement('div');
      container.className = "toast-container fixed top-10 left-0 w-full flex justify-center z-[999] pointer-events-none";
      
      const toast = document.createElement('div');
      toast.innerText = message;
      toast.className = "bg-neon text-black font-black px-8 py-4 rounded-2xl text-[10px] uppercase shadow-[0_10px_30px_rgba(16,185,129,0.2)] border border-black/10 text-center whitespace-pre-line animate-bounce pointer-events-auto";
      
      container.appendChild(toast);
      document.body.appendChild(container);

      setTimeout(() => {
        toast.style.transition = 'all 0.5s ease';
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(-20px)';
        setTimeout(() => container.remove(), 500);
      }, 3000);
    }

    // --- WORKOUT LOGIC ---
    async function doneSet(btn, name, setNum, reps) {
      const rowDiv = btn.closest('.bg-set');
      const weightInput = document.getElementById(`w-${name.replace(/\s/g,'_')}-${setNum}`);
      const weight = parseFloat(weightInput.value);
      btn.innerText = "...";
      btn.disabled = true;

      const res = await callGAS('logSetDone', { 
        program: document.getElementById('program-select').value, 
        nama: name, setKe: setNum, weight: weight, reps: reps 
      });

      if (res === "SUCCESS" || res === "SUCCESS_NEW_PB") {
        // Efek Redup & Ganti ke Centang (Identik dengan hasil refresh)
        rowDiv.classList.add('opacity-40');
        btn.outerHTML = `<span class="text-neon font-black text-lg px-3">âœ“</span>`;
        weightInput.disabled = true;

        if (res === "SUCCESS_NEW_PB") {
          const card = rowDiv.closest('.bg-card');
          card.querySelectorAll('span').forEach(s => {
            if (s.innerText.includes('PB:')) s.innerText = `PB: ${weight}kg`;
          });

          const words = ["ðŸ”¥ LIGHTWEIGHT BABY!!", "ðŸ”¥ GILA, PECAH REKOR!", "ðŸ”¥ BEAST MODE: ON", "ðŸ”¥ GAK ADA OBAT!", "ðŸ”¥ GAINS ARE REAL!"];
          const randomWord = words[Math.floor(Math.random() * words.length)];
          showToast(`${randomWord}\n${weight}KG IS LIGHT!!`);
        }
        startTimer(180);
        callGAS('updateStreak');
      }
    }

    async function loadWorkout() {
      const prog = document.getElementById('program-select').value;
      const container = document.getElementById('workout-container');
      container.innerHTML = "<p class='text-center py-10 text-[10px] text-gray-700 uppercase tracking-widest'>Syncing Routine...</p>";
      
      const data = await callGAS('getWorkoutData', { program: prog });
      
      container.innerHTML = data.map(ex => `
        <div class="bg-card border border-white/5 p-6 rounded-[2rem]">
          <div class="flex justify-between items-baseline mb-5">
            <h3 class="font-bold text-lg uppercase tracking-tighter">${ex.nama}</h3>
            <span class="text-[10px] text-neon font-black italic">PB: ${ex.pbWeight}kg</span>
          </div>
          <div class="space-y-2">
            ${Array.from({length: ex.sets}, (_, i) => {
              const sNum = i + 1;
              const isDone = ex.completedSets.includes(sNum);
              return `
              <div class="flex items-center justify-between p-4 bg-set rounded-xl ${isDone ? 'opacity-40' : ''}">
                <span class="text-[9px] font-bold text-gray-600 uppercase">Set ${sNum}</span>
                <div class="flex items-center gap-2">
                  <input type="number" id="w-${ex.nama.replace(/\s/g,'_')}-${sNum}" value="${ex.currentWeight}" ${isDone ? 'disabled' : ''} 
                         class="w-12 bg-transparent text-center font-bold text-neon text-lg focus:outline-none">
                  <span class="text-[8px] text-gray-700 font-bold uppercase">kg</span>
                </div>
                ${isDone 
                  ? `<span class="text-neon font-black text-lg px-3">âœ“</span>` 
                  : `<button onclick="doneSet(this, '${ex.nama}', ${sNum}, ${ex.reps})" class="text-[10px] font-bold text-white uppercase px-3">Done</button>`
                }
              </div>`;
            }).join('')}
          </div>
        </div>
      `).join('');
    }

    // --- INITIALIZATION & OTHER FUNCTIONS ---
    async function init() {
      lucide.createIcons();
      try {
        const initData = await callGAS('getInitialData');
        document.getElementById('meal-name').innerText = initData.meal.nama;
        document.getElementById('meal-time').innerText = initData.meal.jam;
        document.getElementById('meal-items').innerText = initData.meal.items.join(' â€¢ ');
        
        const mealSection = document.getElementById('meal-section');
        if (initData.hasEaten) {
	      mealSection.classList.add('hidden'); // Sembunyikan jika sudah makan
	    } else {
	      mealSection.classList.remove('hidden'); // Munculkan jika belum makan
	    }

        document.getElementById('streak-val').innerText = `ðŸ”¥ ${initData.streak}`;
        document.getElementById('body-weight-input').value = initData.bodyWeight;
        const select = document.getElementById('program-select');
        select.innerHTML = initData.programs.map(p => `<option value="${p}">${p}</option>`).join('');
        loadWorkout();
      } catch (e) { console.error("Init Error:", e); }
    }

    async function updateBodyWeight(val) {
      if(!val || val <= 0) return;
      const input = document.getElementById('body-weight-input');
      input.style.opacity = "0.5";
      const res = await callGAS('logBodyWeight', { weight: parseFloat(val) });
      if(res === "SUCCESS") {
        input.style.opacity = "1";
        input.style.color = "#10b981";
        setTimeout(() => input.style.color = "white", 2000);
      }
    }

    async function finishMeal(btn) {
  btn.innerText = "LOGGING...";
  const res = await callGAS('logMeal', { name: document.getElementById('meal-name').innerText });
  
  if (res === "SUCCESS") {
    const mealSection = document.getElementById('meal-section');
    
    // Efek transisi biar halus pas ilang
    mealSection.style.transition = "all 0.5s ease";
    mealSection.style.opacity = "0";
    mealSection.style.transform = "scale(0.95)";
    
    setTimeout(() => {
      mealSection.classList.add('hidden');
      showToast("SIP! Kerja Bagus! ðŸ¥—");
    }, 500);
  }
}

    function toggleModal() {
      const modal = document.getElementById('weight-modal');
      modal.classList.toggle('hidden');
      modal.classList.toggle('flex');
      if (!modal.classList.contains('hidden')) {
        const end = new Date();
        const start = new Date();
        start.setDate(end.getDate() - 30);
        document.getElementById('filter-start').value = start.toISOString().split('T')[0];
        document.getElementById('filter-end').value = end.toISOString().split('T')[0];
        showWeightChart(document.getElementById('filter-start').value, document.getElementById('filter-end').value);
      }
    }

    function closeModalOutside(event) { if (event.target.id === 'weight-modal') toggleModal(); }

    async function showWeightChart(start, end) {
      const history = await callGAS('getWeightHistory', { startDate: start, endDate: end });
      const ctx = document.getElementById('weightChart').getContext('2d');
      if (weightChartInstance) weightChartInstance.destroy();
      weightChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: history.map(h => h.dateStr),
          datasets: [{
            data: history.map(h => h.weight),
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            fill: true, tension: 0.4, borderWidth: 3, pointRadius: 4, pointBackgroundColor: '#10b981'
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#666', font: { size: 10 } } },
            x: { grid: { display: false }, ticks: { color: '#666', font: { size: 10 } } }
          }
        }
      });
    }

    function refreshChartWithFilter() { showWeightChart(document.getElementById('filter-start').value, document.getElementById('filter-end').value); }

// Minta izin notifikasi pas apps dibuka
if ("Notification" in window && Notification.permission !== "granted") {
  Notification.requestPermission();
}

function startTimer(sec = 180) {
  clearInterval(timerInterval);
  const timerBox = document.getElementById('timer-box');
  timerBox.classList.remove('hidden');
  timerBox.classList.add('flex'); // Paksa jadi flex biar sejajar horizontal
  
  let leftTime = sec;
  updateTimerDisplay(leftTime);
  
  timerInterval = setInterval(() => {
    leftTime--;
    updateTimerDisplay(leftTime);
    if(leftTime <= 0) {
      stopTimer();
      playTimerEndEffect();
    }
  }, 1000);
}

function updateTimerDisplay(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  document.getElementById('timer-display').innerText = `${mins}:${secs.toString().padStart(2, '0')}`;
}

function stopTimer() {
  clearInterval(timerInterval);
  document.getElementById('timer-box').classList.add('hidden');
}

function playTimerEndEffect() {
  // 1. Getar HP (Pola: Getar 500ms, Diam 200ms, Getar 500ms)
  if (navigator.vibrate) {
    navigator.vibrate([500, 200, 500, 200, 500]);
  }

  // 2. Kirim Notifikasi Push
  if (Notification.permission === "granted") {
    new Notification("IRONTRACKER", {
      body: "WAKTU ISTIRAHAT HABIS! Sikat set berikutnya! ðŸ”¥",
      icon: "https://cdn-icons-png.flaticon.com/512/1041/1041010.png"
    });
  } else {
    // Fallback kalau notif ga aktif
    alert("TIME UP! Sikat set berikutnya! ðŸ¦¾");
  }
}

    window.onload = init;
    
    async function uploadProgressPhoto(input) {
  if (!input.files || !input.files[0]) return;
  
  const file = input.files[0];
  const label = input.parentElement;
  const originalIcon = label.innerHTML;
  
  // Loading state
  label.classList.add('animate-spin');
  label.innerHTML = `<i data-lucide="loader-2" class="w-6 h-6"></i>`;
  lucide.createIcons();

  const reader = new FileReader();
  reader.onload = async function(e) {
    const base64 = e.target.result;
    
    // Panggil fungsi upload di GAS
    const res = await callGAS('uploadPhoto', { base64: base64 });
    
    label.classList.remove('animate-spin');
    if (res === "SUCCESS") {
      showToast("TRANSFORMATION SECURED! ðŸ“¸\nDay logged in Drive.");
      label.innerHTML = `<i data-lucide="check" class="w-6 h-6"></i>`;
      setTimeout(() => {
        label.innerHTML = `<i data-lucide="camera" class="w-6 h-6"></i>`;
        lucide.createIcons();
      }, 3000);
    } else {
      showToast("FAILED TO UPLOAD!");
      label.innerHTML = originalIcon;
      lucide.createIcons();
    }
  };
  reader.readAsDataURL(file);
}

let lastScrollTop = 0;
const photoFab = document.getElementById('photo-fab');

window.addEventListener('scroll', function() {
  let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
  
  if (scrollTop > lastScrollTop && scrollTop > 100) {
    // Scroll ke bawah - Sembunyikan (Geser ke bawah)
    photoFab.style.transform = 'translate(-50%, 150%)';
    photoFab.style.opacity = '0';
  } else {
    // Scroll ke atas - Munculkan (Balik ke posisi semula)
    photoFab.style.transform = 'translate(-50%, 0)';
    photoFab.style.opacity = '1';
  }
  
  lastScrollTop = scrollTop <= 0 ? 0 : scrollTop; 
}, false);

async function togglePhotoModal() {
  const modal = document.getElementById('photo-modal');
  
  // 1. Toggle class hidden
  modal.classList.toggle('hidden');
  
  // 2. Logic Center: Tambahkan flex supaya items-center & justify-center aktif
  if (!modal.classList.contains('hidden')) {
    modal.classList.add('flex'); // Paksa tampil sebagai flexbox
    
    const container = document.getElementById('gallery-container');
    container.innerHTML = `<p class="col-span-2 text-center text-[10px] text-gray-600 uppercase py-20">Fetching your gains...</p>`;
    
    try {
      const photos = await callGAS('getPhotoHistory');
      
      if (!photos || photos.length === 0) {
        container.innerHTML = `<p class="col-span-2 text-center text-[10px] text-gray-600 uppercase py-20">No photos yet. Start training!</p>`;
        return;
      }
      
      // Map foto dengan 2 kolom dan efek grayscale
      container.innerHTML = photos.map(p => `
        <div class="relative group active:scale-95 transition-all cursor-pointer" onclick="window.open('${p.url}', '_blank')">
          <div class="aspect-[3/4] rounded-2xl overflow-hidden border border-white/5 bg-black">
            <img src="https://drive.google.com/thumbnail?id=${p.id}&sz=w300" 
                 class="w-full h-full object-cover grayscale hover:grayscale-0 transition-all duration-500" 
                 loading="lazy">
          </div>
          <div class="absolute bottom-1.5 left-1.5 right-1.5 bg-black/40 backdrop-blur-sm p-1 rounded-lg border border-white/5">
            <p class="text-[7px] font-black uppercase text-white truncate text-center tracking-tighter">${p.name.split(' - ')[0]}</p>
          </div>
        </div>
      `).join('');
      
      lucide.createIcons();
    } catch (err) {
      container.innerHTML = `<p class="col-span-2 text-center text-[10px] text-red-500 uppercase py-20">Error loading photos</p>`;
    }
  } else {
    // 3. Hapus class flex pas ditutup biar gak ganggu UI lain
    modal.classList.remove('flex');
  }
}

function closePhotoModalOutside(e) {
  if(e.target.id === 'photo-modal') togglePhotoModal();
}
  </script>
</body>
</html>
